<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Meeting Summarizer (Saved)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1.25rem; max-width: 1200px; margin: auto; background: #fbfbfb; }
    h1 { margin-bottom: 0.25rem }
    .grid { display: grid; grid-template-columns: 430px 1fr; gap: 1rem; }
    .panel { background: white; border: 1px solid #e3e3e3; padding: 1rem; border-radius: 8px; }
    textarea { width: 100%; height: 64px; }
    pre { white-space: pre-wrap; background:#f7f7f7; padding:1rem; border-radius:6px; max-height:360px; overflow:auto; }
    .meet-list { max-height: 640px; overflow:auto; }
    .meeting-item { padding: 0.5rem; border-bottom: 1px solid #eee; cursor: pointer; }
    .meeting-item:hover { background:#fafafa; }
    table { border-collapse: collapse; width:100% }
    table td, table th { padding: 6px 8px; border: 1px solid #eee; text-align:left }
    .muted { color: #666; font-size: 0.9rem }
    .error { color: #fff; background: #b00020; padding: 0.5rem; border-radius:6px; display:none }
  </style>
</head>
<body>
  <h1>Meeting Summarizer</h1>
  <div class="grid">
    <div class="panel">
      <form id="uploadForm">
        <label><strong>Upload audio (wav/mp3/m4a)</strong></label><br/>
        <input type="file" id="fileInput" name="file" accept="audio/*" required /><br/><br/>
        <label class="muted">Extra instructions (optional)</label>
        <textarea id="instructions" name="prompt_instructions" placeholder="Focus on decisions, tasks, or deadlines."></textarea>
        <div style="margin-top:8px;">
          <button type="submit">Upload & Summarize</button>
        </div>
      </form>

      <div id="errorBox" class="error"></div>

      <hr/>
      <h3>Saved meetings</h3>
      <div class="meet-list" id="meetList"></div>
      <div style="margin-top:12px; font-size:0.9rem; color:#555">
        <div><strong>Note:</strong> Transcripts and summaries are stored locally in <code>meetings.db</code>.</div>
      </div>
    </div>

    <div class="panel" id="viewer">
      <div id="viewerContent">
        <div id="empty" class="muted">No meeting selected. Upload a file or click a saved meeting on the left.</div>
      </div>
    </div>
  </div>

<script>
async function listMeetings() {
  const resp = await fetch("/api/meetings");
  if (!resp.ok) return;
  const data = await resp.json();
  const list = document.getElementById("meetList");
  list.innerHTML = "";
  (data.meetings || []).forEach(m => {
    const el = document.createElement("div");
    el.className = "meeting-item";
    el.innerHTML = `<strong>#${m.id}</strong> ${m.title || m.filename || "(no title)"}<div class="muted">${m.created_at || ""}</div>`;
    el.onclick = () => viewMeeting(m.id);
    list.appendChild(el);
  });
}

async function viewMeeting(id) {
  const resp = await fetch("/api/meetings/" + id);
  const viewer = document.getElementById("viewerContent");
  if (!resp.ok) {
    viewer.innerHTML = "<div class='muted'>Failed to load meeting</div>";
    return;
  }
  const rec = await resp.json();
  const decisionsHtml = (rec.decisions || []).map(d => `<li>${d}</li>`).join("");
  const actionsHtml = (rec.action_items || []).map(a => `
    <tr>
      <td>${a.task || ""}</td>
      <td>${a.assignee || "TBD"}</td>
      <td>${a.due_date || "TBD"}</td>
      <td>${a.rationale || ""}</td>
    </tr>
  `).join("");
  viewer.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div><h2 style="margin:0">${rec.title || "(no title)"}</h2><div class="muted">${rec.created_at || ""}</div></div>
      <div style="text-align:right"><div class="muted">${rec.filename || ""}</div></div>
    </div>
    <h3>Summary</h3>
    <div>${rec.summary || ""}</div>
    <h3>Decisions</h3>
    <ul>${decisionsHtml}</ul>
    <h3>Action items</h3>
    <table>
      <thead><tr><th>Task</th><th>Assignee</th><th>Due</th><th>Rationale</th></tr></thead>
      <tbody>${actionsHtml}</tbody>
    </table>
    <h3>Transcript</h3>
    <pre>${rec.transcript || ""}</pre>
  `;
}

document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  document.getElementById("errorBox").style.display = "none";

  const fileInput = document.getElementById("fileInput");
  if (!fileInput.files.length) { alert("Select an audio file"); return; }
  const form = new FormData();
  form.append("file", fileInput.files[0]);
  form.append("prompt_instructions", document.getElementById("instructions").value || "");

  const btn = e.submitter;
  btn.disabled = true;
  btn.innerText = "Uploading...";

  try {
    const resp = await fetch("/upload", { method: "POST", body: form });
    const data = await resp.json();
    if (!resp.ok) {
      document.getElementById("errorBox").innerText = data.error || JSON.stringify(data);
      document.getElementById("errorBox").style.display = "block";
      return;
    }
    // reload list and show the new meeting
    await listMeetings();
    await viewMeeting(data.id);
    // clear selected file & instructions
    fileInput.value = "";
    document.getElementById("instructions").value = "";
  } catch (err) {
    document.getElementById("errorBox").innerText = "Network error: " + err;
    document.getElementById("errorBox").style.display = "block";
  } finally {
    btn.disabled = false;
    btn.innerText = "Upload & Summarize";
  }
});

window.addEventListener("load", () => {
  listMeetings();
});
</script>
</body>
</html>
